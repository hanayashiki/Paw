#!/bin/sh
# Check if package.json version has changed
# If so, update CHANGELOG.md with the commit message

set -e

export AWS_PROFILE=wcy

# Only run for regular commits (not merges, rebases, etc.)

# Check if package.json is staged for commit
if git diff HEAD^ --cached --name-only | grep -q "package.json"; then
  # Get the current version from package.json
  CURRENT_VERSION=$(node -p "require('./package.json').version")
  
  # Get the version from the last commit
  PREVIOUS_VERSION=$(git show HEAD^:package.json 2>/dev/null | node -p "JSON.parse(require('fs').readFileSync('/dev/stdin', 'utf8')).version" 2>/dev/null || echo "0.0.0")
  
  # If versions are different, update changelog
  if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ]; then
    echo "Bulding for version changed from $PREVIOUS_VERSION to $CURRENT_VERSION"
    # Build the application

    npm run build:mac

    ARTIFACT_DIR=dist/paw-${CURRENT_VERSION}.dmg

    # Upload the build to S3
    if [ -f $ARTIFACT_DIR ]; then
      aws s3 cp $ARTIFACT_DIR s3://paw-cwang-io/paw-${CURRENT_VERSION}.dmg
      echo "Uploaded ${ARTIFACT_DIR} to S3"
    else
      echo "Build artifact not found: ${ARTIFACT_DIR}"
      exit 1
    fi
  fi
fi
